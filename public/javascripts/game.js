function e(e){createjs.Tween.get(h,{loop:!0}).to({x:-a},45*j),createjs.Tween.get(u,{loop:!0}).to({x:a},5e3*j),createjs.Tween.get(g,{loop:!0}).to({x:-a},500*j),createjs.Tween.get(l,{loop:!0}).to({x:-a},80*j)}function t(e){R||(y.volume=0==y.volume?T:0,$(document).trigger("play-pause"),R=!0);var t=e.delta/5;if(!e.paused){f.forEach(function(e,n){treeBounds=e.getBounds(),e.x=e.x+treeBounds.width<=0?e.x=a+treeBounds.width+Math.random()*a:e.x-t}),k.forEach(function(e,n){buildingBounds=e.getBounds(),e.x=e.x+buildingBounds.width<=0?a+buildingBounds.width+Math.random()*a:e.x-t}),w.x+200<0?(w.x=a+(.5+Math.random())*a,x.ditch=!1):w.x=w.x-t;var o=w.localToLocal(0,0,m);if(hitDitch(m.hitTest(o.x,o.y)),Math.random()>.95){var r=Math.random()<.6;dropTokens(r)}if(S.forEach(function(e){var t=e.localToLocal(20,0,m);m.hitTest(t.x,t.y)&&tokenCollected(e,!0)},this),b.forEach(function(e){var t=e.localToLocal(20,0,m);m.hitTest(t.x,t.y)&&tokenCollected(e,!1)},this),"right"==m.move){var s=m.getBounds();m.x=m.x+s.width<a?m.x+7:m.x}else"left"==m.move&&(m.x=m.x>0?m.x-7:m.x);n(e.runTime),createjs.Ticker.getTime(!0)/6e4>=2&&($(document).trigger("play-pause"),$(document).trigger("game-over",["time-out"])),i.update(e)}}function n(e){p.text=new Date(e).toISOString().substr(11,8)}function o(e){if(-1!==location.pathname.search("/play-game")){var t=e.type;39!==e.keyCode&&37!==e.keyCode&&32!==e.keyCode||(39===e.keyCode&&(m.move="keydown"==t?"right":null),37===e.keyCode&&(m.move="keydown"==t?"left":null),32===e.keyCode&&($("#questions-modal").hasClass("open")||"keydown"!=t||$(document).trigger("play-pause")))}}var i,a,r,s,d,c,u,h,g,l,m,p,v,f,w,k,S,b,y,j=100,x={},T=.5,C={value:0,ob:{}},q={value:0,ob:{}},R=!1,B=0,_=[{src:"Sky.png",id:"sky"},{src:"Sun.png",id:"sun"},{src:"Buildings-Back.png",id:"backBg"},{src:"Buildings-Front.png",id:"frontBg"},{src:"Road.png",id:"road"},{src:"Clouds.png",id:"clouds"},{src:"tree-sprite.png",id:"tree"},{src:"building-sprite.png",id:"building"},{src:"ambulance-sprite.png",id:"amb"},{src:"star-sprite.png",id:"star"},{src:"ditch.png",id:"ditch"},{src:"positive-sprite.png",id:"ptoken"},{src:"negative-sprites.png",id:"ntoken"}];$(document).on("initialize-game",function(){i=new createjs.Stage("game-holder"),a=i.canvas.width,r=i.canvas.height,(s=new createjs.LoadQueue(!1)).addEventListener("complete",function(n){$(".preloader").removeClass("loading"),$(".preloader .preloader-wrapper").removeClass("active"),(d=new createjs.Shape).graphics.beginBitmapFill(s.getResult("sky")).drawRect(0,0,a,r);var o=s.getResult("sun");(c=new createjs.Shape).graphics.beginBitmapFill(o).drawRect(o.width,0,o.width,o.height),c.y=.2*o.height,c.x=Math.random()*(a-2*o.width);var y=s.getResult("clouds");(u=new createjs.Shape).graphics.beginBitmapFill(y).drawRect(0,0,5*y.width,y.height),u.x=-4*y.width,u.cache(0,0,5*y.width,y.height);var j=s.getResult("road");(h=new createjs.Shape).graphics.beginBitmapFill(j).drawRect(0,0,2*j.width,j.height),h.tileW=0,h.y=r-j.height,h.cache(0,0,2*j.width,j.height);var x=s.getResult("backBg");(g=new createjs.Shape).graphics.beginBitmapFill(x).drawRect(0,0,2*x.width,x.height),g.y=r-(x.height+j.height),g.cache(0,0,2*x.width,x.height);var T=s.getResult("frontBg");(l=new createjs.Shape).graphics.beginBitmapFill(T).drawRect(0,0,2*T.width,T.height),l.y=r-(T.height+j.height),l.cache(0,0,2*T.width,T.height);var R=s.getResult("ditch");(w=new createjs.Shape).graphics.beginBitmapFill(R).drawRect(0,0,R.width,R.height),w.x=(.5+Math.random())*a,w.y=r-.75*j.height,w.cache(0,0,R.width,R.height);var B={id:"building",width:274,height:126,number:3};k=[];for(var _=new createjs.SpriteSheet({images:[s.getResult(B.id)],frames:{width:B.width,height:B.height}}),A=0;A<=B.number;A++){var E=new createjs.Sprite(_),F=_.getFrameBounds(A);E.gotoAndStop(A),E.setTransform(Math.random()*a,r-(j.height+F.height)+2),k.push(E)}var M=new createjs.SpriteSheet({images:[s.getResult("tree")],frames:{width:100,height:150}});v=function(){for(var e=[],t=0;t<4;t++){var n=new createjs.Sprite(M),o=M.getFrameBounds(t);n.gotoAndStop(t),n.setTransform(Math.random()*a,r-(j.height+o.height)+2),e.push(n)}return e};N=new createjs.SpriteSheet({framerate:3,images:[s.getResult("amb")],frames:{regX:0,height:150,count:15,regY:0,width:150},animations:{run:[0,4,"run",1.5],hickup:[5,6,"run"],plus:[7,10,"run",6],minus:[11,14,"run",6]}});(m=new createjs.Sprite(N,"run")).x=.1*a,m.y=r-3*j.height,m.setBounds(0,0,150,150);var P=new createjs.SpriteSheet({images:[s.getResult("ptoken")],frames:{width:47,height:47}}),O=new createjs.SpriteSheet({images:[s.getResult("ntoken")],frames:{width:47,height:47}});createTokens=function(){for(S=[],t=1;t<=4;t++){var e=new createjs.Sprite(P);e.gotoAndStop(t),S.push(e)}b=[];for(var t=1;t<=2;t++){var n=new createjs.Sprite(O);n.gotoAndStop(t),b.push(n)}},C.ob=new createjs.Text("POINTS:"+C.value,"30px monospace","#00000"),C.ob.x=10,C.ob.y=10,(p=new createjs.Text("00:00:00","30px monospace","#00000")).x=a-150,p.y=10;var N=new createjs.SpriteSheet({images:[s.getResult("star")],frames:{height:27,width:112}});q.ob=new createjs.Sprite(N),q.ob.numFrames=N.getNumFrames(),q.ob.x=10,q.ob.y=50,i.addChild(d,c,u,g,l,h,w,C.ob,q.ob,p),(f=v()).forEach(function(e){i.addChild(e)}),k.forEach(function(e){i.addChild(e)}),createTokens(),i.addChild(m),createjs.Ticker.timingMode=createjs.Ticker.RAF,createjs.Ticker.interval=100,createjs.Ticker.on("tick",t),e()}),s.loadManifest(_,!0,"../images/"),[{path:"../audio/bg-music.mp3",key:"music",type:"mp3",main:!0},{path:"../audio/got-item.mp3",key:"plusSound",type:"mp3"},{path:"../audio/lost-item.mp3",key:"minusSound",type:"mp3"}].forEach(function(e){createjs.Sound.alternateExtensions=[e.type],e.main&&createjs.Sound.on("fileload",function(){y=createjs.Sound.play(e.key,{interrupt:createjs.Sound.INTERRUPT_NONE,loop:-1,volume:0})},this),createjs.Sound.registerSound(e.path,e.key)},this)}),dropTokens=function(e){var t=e?S:b,n=t[Math.floor(Math.random()*t.length-1)+1];n.isAnimating||(n.isAnimating=!0,n.notCollectd=!0,n.x=Math.floor(Math.random()*a)+1,n.y=-200,i.addChild(n),createjs.Tween.get(n).to({y:a},45*j).call(function(){n.isAnimating=!1,i.removeChild(n)}))},tokenCollected=function(e,t){if(i.removeChild(e),e.notCollectd){e.notCollectd=!1,C.value=t?C.value+10:C.value-10,C.ob.text="SCORE:"+C.value;var n=.25*y.volume;t?(B<3&&(B++,$(document).trigger("hint-indicator-change",[B-1])),3===B&&$(document).trigger("showhint"),createjs.Sound.play("plusSound",{volume:n}),m.gotoAndPlay("plus"),$(document).trigger("token-caught",[!0])):(createjs.Sound.play("minusSound",{volume:n}),m.gotoAndPlay("minus"),$(document).trigger("token-caught",[!1]))}},hitDitch=function(e){!x.ditch&&e&&(x.ditch=!0,m.gotoAndPlay("hickup"),$(document).trigger("hit-ditch"))},$(window).on("keydown",o),$(window).on("keyup",o),$("#mute-btn").on("click",function(){createjs.Ticker.getPaused()||$(this).toggleClass("btn-clicked"),$(document).trigger("toggle-mute")}),$("#start-btn").on("click",function(){$(document).trigger("play-pause")}),$(document).on("hit-ditch",function(){$(document).trigger("play-pause"),$(document).trigger("showquestion")}),$(document).on("play-pause",function(){createjs.Ticker.setPaused(!createjs.Ticker.getPaused()),$("#start-btn").toggle(),$(document).trigger("toggle-mute")}),$(document).on("update-star",function(){q.ob.gotoAndStop(++q.ob.currentFrame%q.ob.numFrames)}),$(document).on("toggle-mute",function(){var e=$("#mute-btn");0!=y.volume||e.hasClass("btn-clicked")||createjs.Ticker.getPaused()?($("#mute-btn").addClass("active"),y.volume=0):(e.removeClass("active"),y.volume=T)}),$(document).on("plusSound",function(){createjs.Sound.play("plusSound",{volume:.25*T})}),$(document).on("minusSound",function(){createjs.Sound.play("minusSound",{volume:.25*T})});var A=!1,E=0,F=0,M=0,P=0,O=0,N=!1;$(".modal").modal({dismissible:!1});var L=function(e){$(e).removeClass("invalid"),$(e).find("input").prop("checked",!1).removeAttr("disabled")};$(document).on("showhint",function(){if(!A){var e=$(".question").eq(E).find(".hint").text();""!==e&&(e='<b class="green-text">Hint: </b>'+e,Materialize.toast(e,4e7),A=!0)}}),$(document).on("showquestion",function(){$(".question").addClass("hide"),$(".question").eq(E).removeClass("hide"),$("#questions-modal").modal("open"),$("#questions-modal").css({display:"block"})}),$("#questionClose").on("click",function(){$(".toast").fadeOut(600,function(){$(".toast").remove()}),$(document).trigger("hint-indicator-change",["RESET"]),$(".question").eq(E).hasClass("valid")?(setTimeout(function(){$(document).trigger("update-star"),$(document).trigger("update-star"),5===F&&($(document).trigger("play-pause"),$(document).trigger("show-loader"),N&&(location.href="/game-over/"+location.pathname.split("/").pop()))},600),$(".question").eq(E).remove()):(L($(".question").eq(E)),$(".question").length===E?E=0:E++),B=0,$("#questions-modal").modal("close"),$("#questionClose").attr("disabled",!0),A=!1,$(document).trigger("play-pause")}),$(".question input").on("click",function(){$("#questionSubmit").removeAttr("disabled")}),$("#questionSubmit").on("click",function(){var e=$(".question").eq(E),t=$(e).find("input:checked").val(),n=$(e).attr("id");$("#questionSubmit").attr("disabled",!0),$(e).find("input").attr("disabled",!0);var o=["a","b","c","d"];$.ajax({method:"POST",url:"/check-answer/"+$("#mute-btn").data("id")+"/"+n,data:{answeredAs:t,Negative_Tokens_Caught__c:O,Positive_Tokens_Caught__c:P,Time_Taken__c:parseInt((createjs.Ticker.getTime(!0)/1e3).toFixed(0),10)},cache:!1,success:function(t){M++,O=0,P=0,t.answeredCorrect?($(e).addClass("valid"),F++,$(document).trigger("plusSound")):($(e).addClass("invalid"),$(document).trigger("minusSound"),$(e).find("p").eq(o.indexOf(t.correctOption)).addClass("correct-answer")),$("#questionClose").removeAttr("disabled"),t.endGame&&(N=!0)},error:function(e){console.info(e)}})}),$(document).on("token-caught",function(e,t){t?P++:O++}),$(document).on("hint-indicator-change",function(e,t){var n=$(".hit-progress .messages"),o=$(".hit-progress .progress-show .determinate");"RESET"===t?($(n).removeAttr("style"),$(o).removeAttr("style")):($(n).css("margin-top","-"+20*(t+1)+"px"),$(o).eq(t).css("width","99.99%"))}),$(document).on("game-over",function(e,t){"time-out"===t&&$.ajax({url:"/saveAttempt/"+$("#mute-btn").data("id"),method:"POST",cache:!1,data:{Negative_Tokens_Caught__c:O,Positive_Tokens_Caught__c:P},success:function(e){location.href="/game-over/"+location.pathname.split("/").pop()},error:function(e){console.log(e)}})});